<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Med'z Laundry Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="assets/style.css">
</head>

<body>
    <header>
        <nav class="nav">
            <div style="display: flex;gap: 1rem">
                <div class="nav-brand">
                    <img src="assets/images/LOGO.jpeg">
                    <div class="brand-text-main">
                        <a href="index.html">MED'Z LAUNDRY SHOP</a>
                    </div>
                </div>
                <div class="nav-links">
                    <a href="admin-inquiry-records.html">Inquiries</a>
                    <a href="admin-booking-records.html" class="active">Booking</a>
                    <a href="admin-sales-records.html">Sales</a>
                </div>
            </div>
            <div class="nav-cta">
                <a href="#" class="btn btn-accent" id="btn-header-logout">Logout</a>
            </div>
        </nav>
    </header>
    <main class="page">
        <section id="about">
            <h2 class="section-title">List of Booking</h2>
            <div class="section-tagline">ADMIN â€¢ BOOK</div>
            <div class="table-wrapper">
                <table width="100%" border="1">
                    <thead>
                    <th>NAME</th>
                    <th>PHONE</th>
                    <th>DATE</th>
                    <th>TIME</th>
                    <th>TYPE</th>
                    <th>KILOS</th>
                    <th>NOTES</th>
                    <th>ACTION</th>
                    </thead>
                    <tbody id="booking-records">
                    </tbody>
                </table>
            </div>
        </section>
    </main>
    <footer>
        &copy; <span>Med'z Laundry Shop</span>
    </footer>

    <script src="config.js"></script>
    <script type="module">
      import {
        initializeApp
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js'
      import {
        getDatabase,
        ref,
        onChildAdded,
        onChildChanged,
        onChildRemoved,
        remove
      } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js'
      const app = initializeApp(window.FIREBASE_CONFIG);
      const auth = getAuth(app)
      const db = getDatabase(app)
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'login.html'
        }
      })
      const bookingsRef = ref(db, 'bookings')
      const tableBody = document.getElementById('booking-records')
      tableBody.appendChild(createRow('0', null))
      function createRow(key, data) {
        const row = document.createElement('tr')
        row.dataset.key = key // store the Firebase key on the row
        if (!data) {
          row.insertAdjacentHTML('beforeend', ` <td colspan="8">Loading...</td>`)
          return row
        }
        row.insertAdjacentHTML(
          'beforeend',
          `
            <td>${data.name}</td>
            <td>${data.phone}</td>
            <td>${data.date}</td>
            <td>${data.time}</td>
            <td>${data.type}</td>
            <td>${data.kilos}</td>
            <td>${data.notes}</td>
            <td><button class="delete-btn" data-key="${key}">Delete</button> </td>
            `,
        )
        return row
      }
      onChildAdded(bookingsRef, (snapshot) => {
        const data = snapshot.val()
        const key = snapshot.key
        let row = tableBody.querySelector(`tr[data-key="${key}"]`)
        const loadingRow = tableBody.querySelector(`tr[data-key="0"]`)
        if (loadingRow) {
          loadingRow.remove()
        }
        if (!row) {
          row = createRow(key, data)
          tableBody.appendChild(row)
        }
      })
      onChildChanged(bookingsRef, (snapshot) => {
        const data = snapshot.val()
        const key = snapshot.key
        const row = tableBody.querySelector(`tr[data-key="${key}"]`)
        if (!row) {
          const newRow = createRow(key, data)
          tableBody.appendChild(newRow)
          return
        }
        const cells = row.querySelectorAll('td')
        cells[0].textContent = data.name
        cells[1].textContent = data.phone
        cells[2].textContent = data.date
        cells[3].textContent = data.time
        cells[4].textContent = data.type
        cells[5].textContent = data.kilos
        cells[6].textContent = data.notes
      })
      onChildRemoved(bookingsRef, (snapshot) => {
        const key = snapshot.key
        const row = tableBody.querySelector(`tr[data-key="${key}"]`)
        if (row) {
          row.remove()
        }
      })

      tableBody.addEventListener('click', (event) => {
        const btn = event.target.closest('.delete-btn')
        if (!btn) return
        const key = btn.dataset.key
        if (!key) return
        const ok = confirm('Are you sure you want to delete this record?')
        if (!ok) return
        const recordRef = ref(db, 'bookings/' + key)
        remove(recordRef)
          .then(() => {
            const row = btn.closest('tr')
            if (row) row.remove()
          })
          .catch((err) => {
            console.error('Failed to delete:', err)
            alert('Failed to delete record. Please try again.')
          })
      })
      const logoutBtn = document.getElementById('btn-header-logout')
      logoutBtn.addEventListener('click', () => {
        signOut(auth).catch((error) => {
          console.error('Logout error:', error)
        })
      })
    </script>
</body>
</html>
